<!DOCTYPE html>
<html>
	<head>
	<meta charset="UTF-8">
	<title>title</title>
	</head>
	<body>
		<div class='js-view'>
			<div class='layout-i'>
				<div class='slot-1 js-slot' data-slot='1'>
					<div class='module-apple'>
						<h1>This is module apple title</h1>
						<div>This is module apple body</div>
					</div>
				</div>
				<div class='slot-2 js-slot' data-slot='2'>
					<div class='module-orange'>
						<h1>This is module orange title</h1>
						<div>This is module orange body</div>
					</div>
				</div>
				<div class='slot-3 js-slot' data-slot='3'>
					<div class='module-tangerine'>
						<div class='module-tangerine-item'>
							<h1>Tangerine item title</h1>
							<div class='slot-4 js-slot' data-slot='4'>
								<div class='module-sharon'>
									I am module sharon.
								</div>
							</div>
						</div>
						<div class='module-tangerine-item'>
							<h1>Tangerine item title</h1>
							<div class='slot-5 js-slot' data-slot='5'>
								<div class='module-sharon'>
									I am module sharon.
								</div>
							</div>
						</div>
						<div class='module-tangerine-item'>
							<h1>Tangerine item title</h1>
							<div class='slot-6 js-slot' data-slot='6'>
								<div class='module-sharon'>
									I am module sharon.
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	<script>

		function extend(original, source) {
			for (var prop in source) { original[prop] = source[prop]; }
			return original;
		}


		function templateNode(data) {
			var el = document.createElement('div');
			el.innerHTML = "<div>Data: " + JSON.stringify(data) + "</div>";
			return el.firstChild;
		}

		var FruitMachine = function(props) {
			this.root = props.root;
			this.el = this.root.firstElementChild;
			this.slots = props.slots || getSlots(this.root);

			this._data = props.structure.data || {};
			this.subviews = props.structure.subviews || [];
			this._subviewRef = {};
			this.subviews.forEach(this.createSubview, this);
		}

		extend(FruitMachine.prototype, {

			render: function() {
				this.el = templateNode(this.get());
				this.inject(this.root);
				return this;
			},

			inject: function(target) {
				target.innerHTML = '';
				target.appendChild(this.el);
				return this;
			},

			set: function(data) {
				extend(this._data, data);
				return this;
			},

			get: function(key) {
				return key ? this._data[key] : this._data;
			},

			getSubview: function(query) {
				return this._subviewRef['slot-' + query]
					|| this._subviewRef['module-' + query];
			},

			createSubview: function(subview) {
				var root = this.slots[subview.slot];

				// If no root node was found in the DOM
				// then this item must not exist in the markup.
				// In that case, just return and move on.
				if (!root) {
					return;
				}

				subview.view
					= this._subviewRef['slot-' + subview.slot]
					= this._subviewRef['module-' + subview.module]
					= new FruitMachine({ root: root, slots: this.slots, structure: subview });
			}
		});



		function getSlots(node) {
			var nodes = root.getElementsByClassName('js-slot');
			var slots = {};

			Array.prototype.forEach.call(nodes, function(node) {
				slots[node.getAttribute('data-slot')] = node;
			});

			return slots;
		}


		var structure = {
			layout: 'i',
			subviews: [
				{
					module: 'apple',
					slot: 1
				},
				{
					module: 'orange',
					slot: 2
				},
				{
					module: 'tangerine',
					slot: 3,
					subviews: [
						{
							module: 'sharon',
							slot: 4
						},
						{
							module: 'sharon',
							slot: 5
						},
						{
							module: 'sharon',
							slot: 6
						}
					]
				}
			]
		}


		var root = document.querySelector('.js-view').cloneNode(true);

		var fruitMachineView = new FruitMachine({
			root: root,
			structure: structure
		});

		fruitMachineView.getSubview('apple')
			.set({ my: 'new data' })
			.render();

		fruitMachineView.inject(document.querySelector('.js-view'));

	</script>
	</body>
</html>