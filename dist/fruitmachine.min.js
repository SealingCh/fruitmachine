(function(){function c(a){a=g({},a);if(a.module){var b=f.modules[a.module]||d;a._module=a.module;delete a.module;return new b(a)}this._configure(a);this.add(a.children);this.onInitialize(a);this.trigger("initialize",[a],{propagate:!1})}function j(a){this.fmid=i.uniqueId("model");this._data=g({},a)}function d(a){return new c(a)}d.VERSION="0.0.1";var m=Array.prototype.slice,n=Object.prototype.hasOwnProperty,o="undefined"!==typeof document,i={bind:function(a,b){return function(){return a.apply(b,arguments)}},
isArray:function(a){return a instanceof Array},mixin:function(a){m.call(arguments,1).forEach(function(b){for(var e in b)a[e]=b[e]});return a},querySelectorId:function(a,b){if(b)return b.querySelector("#"+a)},insert:function(a,b,e){"undefined"!==typeof e?b.splice(e,0,a):b.push(a)},uniqueId:function(){var a=0;return function(b,e){return[b||"id",++a*Math.round(1E5*Math.random()),e||"a"].join("-")}}()},g=i.mixin;d.util=i;var l=/\s+/,k={on:function(a,b,e){var c,h,d,f,g;if(!b)return this;a=a.split(l);c=
this._callbacks||(this._callbacks={});for(h=a.shift();h;)d=(g=c[h])?g.tail:{},d.next=f={},d.context=e,d.callback=b,c[h]={tail:f,next:g?g.next:d},h=a.shift();return this},off:function(a,b,e){var c,h,d,f,g,i;if(h=this._callbacks){if(!a&&!b&&!e)return delete this._callbacks,this;for(a=a?a.split(l):Object.keys(h);c=a.shift();)if(d=h[c],delete h[c],d&&(b||e))for(f=d.tail;(d=d.next)!==f;)if(g=d.callback,i=d.context,b&&g!==b||e&&i!==e)this.on(c,g,i);return this}},trigger:function(a){var b,e,c,d,g,f;if(!(c=
this._callbacks))return this;g=c.all;a=a.split(l);for(f=m.call(arguments,1);b=a.shift();){if(e=c[b])for(d=e.tail;(e=e.next)!==d;)e.callback.apply(e.context||this,f);if(e=g){d=e.tail;for(b=[b].concat(f);(e=e.next)!==d;)e.callback.apply(e.context||this,b)}}return this}};d.Events=k;c.prototype._configure=function(a){this._id=a.id||i.uniqueId("auto_");this._fmid=a.fmid||i.uniqueId("fmid");this.tag=a.tag||this.tag||"div";this.classes=this.classes||a.classes||[];this._module=this._module||a._module;this.helpers=
this.helpers||a.helpers||[];this.template=this.getTemplate();this._lookup={};this._children=[];this.model=a.model||new j(a.data||{});this.helpers.forEach(this.attachHelper,this);this.purgeHtmlCache=i.bind(this.purgeHtmlCache,this);this.model.on("change",this.purgeHtmlCache)};c.prototype.on=k.on;c.prototype.off=k.off;c.prototype.trigger=function(a,b,e){i.isArray(b)||(e=b,b=[]);e=e||{target:this,stopPropagation:function(){this.propagate=false}};k.trigger.apply(this,[a,e].concat(b));!1!==e.propagate&&
this.parent&&this.parent.trigger(a,b,e);return this};c.prototype.attachHelper=function(a){(a="function"===typeof a?a:f.helpers[a])&&a(this,d)};c.prototype.getTemplate=function(){var a=this.template||d.templates.get(this._module);return!a?console.warn("FM - No template for %s",this._module):a.render?i.bind(a.render,a):a};c.prototype.add=function(a,b){var e=b&&b.at,d=b&&b.inject,h;if(a){for(var a=[].concat(a),f=0,g=a.length;f<g;f++)h=a[f],h instanceof c||(h=new c(h)),i.insert(h,this._children,e),this._addLookup(h),
h.parent=this,d&&this.injectElement(h.el,b);this.purgeHtmlCache();return this}};c.prototype._addLookup=function(a){this._lookup[a.id()]=a;this._lookup[a._module]=this._lookup[a._module]||[];this._lookup[a._module].push(a)};c.prototype._removeLookup=function(a){var b=this._lookup[a._module].indexOf(a);this._lookup[a._module].splice(b,1);delete this._lookup[a._id]};c.prototype.injectElement=function(a,b){var e=b&&b.at,c=this.el;a&&c&&("undefined"!==typeof e?c.insertBefore(a,c.children[e]):c.appendChild(a))};
c.prototype.id=function(a){return a?this.module(a):this._id};c.prototype.child=function(a){if(a=this._lookup[a])return a[0]||a};c.prototype.module=function(a){var b;return!a?this._module:(b=this._lookup[a])?b[0]||b:this.each(function(b){return b.child(a)})};c.prototype.children=function(a){return!a?this._children:this._lookup[a]||[]};c.prototype.modules=function(a){var b=this._lookup[a]||[];this.each(function(c){b=b.concat(c.children(a))});return b};c.prototype.each=function(a){for(var b=this.children(),
c=b.length,d,f=0;f<c;f++)if(d=a(b[f]))return d};c.prototype.toHTML=function(){var a={},b;if(this.html)return this.html;a.children=[];this.each(function(c){b=c.toHTML();a[c.id()]=b;a.children.push(g({child:b},c.model.get()))});b=this.template(g(a,this.model.get()));return this.html=this._wrapHTML(b)};c.prototype._wrapHTML=function(a){return"<"+this.tag+' class="'+this._module+" "+this.classes.join(" ")+'" id="'+this._fmid+'">'+a+"</"+this.tag+">"};c.prototype.purgeHtmlCache=function(){this.html=null;
this.parent&&this.parent.purgeHtmlCache();return this};c.prototype.render=function(){this.setElement(this.toNode());this.trigger("render",{propagate:!1});return this};c.prototype.setup=function(a){(!a||!a.shallow)&&this.each(function(a){a.setup()});if(!this.getElement())return this;this.isSetup&&this.teardown({shallow:!0});this.trigger("setup",{propagate:!1});this.onSetup();this.isSetup=!0;return this};c.prototype.teardown=function(a){(!a||!a.shallow)&&this.each(function(a){a.teardown()});if(!this.isSetup)return this;
this.trigger("teardown",{propagate:!1});this.onTeardown();this.isSetup=!1;return this};c.prototype.destroy=function(a){for(var b=this._children,c=b.length;c--;)b[c].destroy({el:!1});if(this.destroyed)return this;this.remove(a);this.teardown(a);this.trigger("destroy",{propagate:!1});this.onDestroy();this.model.off("change",this.purgeHtmlCache);this.off();this.destroyed=!0;this.el=this.model=this.parent=this._lookup=this._module=this._id=null};c.prototype.onInitialize=function(){};c.prototype.onSetup=
function(){};c.prototype.onTeardown=function(){};c.prototype.onDestroy=function(){};c.prototype.remove=function(a){var a=a||{},b=this.el;!1!==a.el&&b&&b.parentNode&&b.parentNode.removeChild(b);if(!this.parent)return this;this.parent._children.splice(this.parent._children.indexOf(this),1);this.parent._removeLookup(this);return this};c.prototype.empty=function(){for(var a=this.children(),b=a.length;b--;)a[b].destroy();return this};c.prototype.closestElement=function(){for(var a=this.parent;a&&!a.el&&
a.parent;)a=a.parent;return a&&a.el};c.prototype.getElement=function(){if(o)return this.el=this.el||document.getElementById(this._fmid)||this.parent&&i.querySelectorId(this._fmid,this.closestElement())};c.prototype.setElement=function(a){var b=this.el;b&&b.parentNode&&b.parentNode.replaceChild(a,b);this.purgeElementCaches();this.el=a;return this};c.prototype.purgeElementCaches=function(){this.each(function(a){a.purgeElementCaches()});this.el=null};c.prototype.data=function(a,b){if(!a&&!b)return this.model.get();
if("string"===typeof a&&!b)return this.model.get(a);if(a&&b)return this.model.set(a,b),this;if("object"===typeof a)return this.model.set(a),this};c.prototype.inDOM=function(){return this.parent?this.parent.inDOM():!(!this.el||!this.el.parentNode)};c.prototype.toNode=function(){var a=document.createElement("div");a.innerHTML=this.toHTML();return a.removeChild(a.firstElementChild)};c.prototype.inject=function(a){a&&(a.innerHTML="",this.appendTo(a));return this};c.prototype.appendTo=function(a){this.el&&
(a&&a.appendChild)&&a.appendChild(this.el);return this};c.prototype.toJSON=function(){var a={children:[]};this.each(function(b){a.children.push(b.toJSON())});a.id=this.id();a.fmid=this._fmid;a.module=this._module;a.data=this.model.get();return a};d.View=c;j.prototype.get=function(a){return a?this._data[a]:this._data};j.prototype.set=function(a,b){var c;"string"===typeof a&&b&&(c={},c[a]=b,a=c);if("object"===typeof a){g(this._data,a);this.trigger("change");for(var d in a)this.trigger("change:"+d,a[d])}return this};
j.prototype.clear=function(){this._data={};return this};j.prototype.destroy=function(){this._data=null};j.prototype.toJSON=function(){return g({},this._data)};g(j.prototype,k);d.Model=j;c.extend=function(a,b){var c=this,d;d=a&&n.call(a,"constructor")?a.constructor:function(){return c.apply(this,arguments)};g(d,c,b);var f=function(){this.constructor=d};f.prototype=c.prototype;d.prototype=new f;a&&g(d.prototype,a);d.__super__=c.prototype;return d};var f={modules:{},templates:{},helpers:{}};d.store=
f;d.module=function(a){var b=a.module||"undefined";delete a.module;a=a.__super__?a:d.View.extend(a);a.prototype._module=b;return f.modules[b]=a};d.module.clear=function(a){a?delete f.modules[a]:f.modules={}};d.helper=function(a,b){f.helpers[a]=b};d.helper.clear=function(a){a?delete f.helpers[a]:f.helpers={}};d.templates=function(a){var b=typeof a;"object"===b?g(f.templates,a):"function"===b&&(d.templates.get=a)};var p=d.templates.get=function(a){return f.templates[a]};d.templates.clear=function(a){a?
delete f.templates[a]:(f.templates={},d.templates.get=p)};"object"===typeof exports?module.exports=d:"function"===typeof define&&define.amd?define(d):window.FruitMachine=d})();
