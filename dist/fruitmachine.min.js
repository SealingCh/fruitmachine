(function(){var j,k,l,f=function(a){a=a||{};if(a.module){var b=j[a.module]||f;a._module=a.module;delete a.module;return new b(a)}this._configure(a);this.add(a.views||this.views);this.onInitialize(a)};f.VERSION="0.0.1";j={};k={};l={};var i=f.util={bind:function(a,b){return function(){return a.apply(b,arguments)}},bindAll:function(a,b){for(var c in a)"function"===typeof a[c]&&(a[c]=i.bind(a[c],b))},mixin:function(a){n.call(arguments,1).forEach(function(b){for(var c in b)a[c]=b[c]});return a},insertChild:function(a,
b,c){b&&("undefined"!==typeof c?b.insertBefore(a,b.children[c]):b.appendChild(a))},insert:function(a,b,c){"undefined"!==typeof c?b.splice(c,0,a):b.push(a)},uniqueId:function(){var a=0;return function(b,c){return[b||"id",++a*Math.round(1E5*Math.random()),c||"a"].join("-")}}()},n=Array.prototype.slice,r=Object.prototype.hasOwnProperty,g=i.mixin,m=/\s+/,o=f.Events={on:function(a,b,c){var d,e,h,f,g;if(!b)return this;a=a.split(m);d=this._callbacks||(this._callbacks={});for(e=a.shift();e;)h=(g=d[e])?g.tail:
{},h.next=f={},h.context=c,h.callback=b,d[e]={tail:f,next:g?g.next:h},e=a.shift();return this},off:function(a,b,c){var d,e,h,f,g,i;if(e=this._callbacks){if(!a&&!b&&!c)return delete this._callbacks,this;for(a=a?a.split(m):Object.keys(e);d=a.shift();)if(h=e[d],delete e[d],h&&(b||c))for(f=h.tail;(h=h.next)!==f;)if(g=h.callback,i=h.context,b&&g!==b||c&&i!==c)this.on(d,g,i);return this}},trigger:function(a){var b,c,d,e,f,g;if(!(d=this._callbacks))return this;f=d.all;a=a.split(m);for(g=n.call(arguments,
1);b=a.shift();){if(c=d[b])for(e=c.tail;(c=c.next)!==e;)c.callback.apply(c.context||this,g);if(c=f){e=c.tail;for(b=[b].concat(g);(c=c.next)!==e;)c.callback.apply(c.context||this,b)}}return this}};f.helper=function(a,b){l[a]=b(f)};var p=function(a){return k[a]};f.templates=function(a){var b=typeof a;"object"===b?g(k,a):"function"===b&&(p=a)};var s=function(a){var b=l[a];if(b)return"function"===typeof b?this[a]=new b(this):g(this,b)},t=function(a){if(a.onSetup)a.onSetup()},u=function(a){if(a.onTeardown)a.onTeardown()};
g(f.prototype,o,{_configure:function(a){this._id=a.id||i.uniqueId("auto_");this._fmid=a.fmid||i.uniqueId("fmid");this.module=this.module||a._module;this._lookup={};this._children=[];this.model=a.model||new q(a.data||{});this.template=this.template||p(this.module);this.helpers=(this.helpers||[]).map(s,this)},onInitialize:function(){},onSetup:function(){},onTeardown:function(){},onDestroy:function(){},add:function(a,b){var c=b&&b.at,d=b&&b.insert,e;if(a){for(var a=[].concat(a),g=0,j=a.length;g<j;g++)e=
a[g],e instanceof f||(e=new f(e)),i.insert(e,this._children,c),this.addLookup(e),e.parent=this,d&&this.insertChildEl(e.el(),b);return this}},insertChildEl:function(a,b){var c=b&&b.at,d=this.el();a&&d&&("undefined"!==typeof c?d.insertBefore(a,d.children[c]):d.appendChild(a))},addLookup:function(a){this._lookup[a.id()]=a;this._lookup[a.module]=this._lookup[a.module]||[];this._lookup[a.module].push(a)},id:function(a){return a?this._lookup[a]:this._id},child:function(a){return this._lookup[a][0]},children:function(a){return a?
this._lookup[a]:this._children},fmid:function(){return this._fmid},toHTML:function(){var a={},b=this.children(),c,d;a.children=[];if(!this.template)return console.log("FM - No template for %s",this.module);for(var e=0,f=b.length;e<f;e++)c=b[e],d=c.toHTML(),a[c.id()]=d,a.children.push({child:d});a.fm_attrs='id="'+this.fmid()+'"';return this._html=this.template.render(g(a,this.model.get()))},render:function(){return this.update()},setup:function(a){var b=a&&a.shallow,a=this.children();if(!b)for(var b=
0,c=a.length;b<c;b++)a[b].setup();this.isSetup&&this.teardown({shallow:!0});this.helpers.forEach(t,this);this.onSetup();this.trigger("setup");this.isSetup=!0;return this},teardown:function(a){var b=a&&a.shallow,a=this.children();if(!b)for(var b=0,c=a.length;b<c;b++)a[b].teardown();this.helpers.forEach(u,this);this.trigger("teardown");this.onTeardown();this.isSetup=!1;return this},destroy:function(a){for(;this._children.length;)this._children[0].destroy({remove:!1});this.teardown(a);this._detach(a);
this.trigger("destroy");this.onDestroy();this.destroyed=!0;this._el=this.module=this._id=this._lookup=null},remove:function(){var a=this.el();a&&a.parentNode&&a.parentNode.removeChild(a)},_detach:function(a){!1!==(a&&a.skipEl)&&this.remove();if(!this.parent)return this;a=this.parent._children.indexOf(this);this.parent._children.splice(a,1);a=this.parent._lookup[this.module].indexOf(this);this.parent._lookup[this.module].splice(a,1);delete this.parent._lookup[this._id];return this},parentEl:function(){for(var a=
this.parent;a&&!a._el&&a.parent;)a=a.parent;return a._el},el:function(){if("undefined"!==typeof document)return this._el=this._el||document.getElementById(this.fmid())},data:function(a,b){if(!a&&!b)return this.model.get();if("string"===typeof a&&!b)return this.model.get(a);if(a&&b)return this.model.set(a,b),this;if("object"===typeof a)return this.model.set(a),this},update:function(){var a=this.el(),b=this.toNode();if(!a)return this._el=b,this;a.parentNode.replaceChild(b,a);this._el=b;return this},
toNode:function(){var a=document.createElement("div");a.innerHTML=this.toHTML();return a.firstElementChild},inject:function(a){var b=this.el();if(b)return a.innerHTML="",a.appendChild(b),this},toJSON:function(){var a={},b=this.children();a.views=[];for(var c=0,d=b.length;c<d;c++)a.views.push(b[c].toJSON());a.id=this.id();a.fmid=this.fmid();a.module=this.module;a.model=this.model.get();return a}});var q=f.Model=function(a){this._data=g({},a)};g(q.prototype,o,{get:function(a){return a?this._data[a]:
this._data},set:function(a,b){if("object"===a){g(this._data,a);this.trigger("datachange");for(var c in a)this.trigger("datachange:"+c,a[c])}else"string"===typeof a&&b&&(this._data[a]=b,this.trigger("datachange",a,b),this.trigger("datachange:"+a,b));return this},toJSON:function(){return g({},this._data)}});f.inherit=function(a,b){var c=this,d;d=a&&r.call(a,"constructor")?a.constructor:function(){return c.apply(this,arguments)};g(d,c,b);var e=function(){this.constructor=d};e.prototype=c.prototype;d.prototype=
new e;a&&g(d.prototype,a);d.__super__=c.prototype;return d};f.module=function(a,b){if("string"===typeof a)return b.module=a,j[a]=f.inherit(b);if("object"===typeof a)return f.inherit(a)};"object"===typeof exports?module.exports=f:"function"===typeof define&&define.amd?define(f):window.FruitMachine=f})();
