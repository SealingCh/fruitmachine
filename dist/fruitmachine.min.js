/*! fruitmachine 2013-03-30 */
(function(){"use strict";function t(e){if(e=h({},e),e.module){var i=u.modules[e.module]||t;return e._module=e.module,delete e.module,new i(e)}this._configure(e),this.add(e.children),this.onInitialize(e),this.trigger("initialize",[e],{propagate:!1})}function e(t){this.fmid=s.uniqueId("model"),this._data=h({},t)}function i(e){return new t(e)}i.VERSION="0.0.1";var o=Array.prototype.slice,n=Object.prototype.hasOwnProperty,r="undefined"!=typeof document,s={bind:function(t,e){return function(){return t.apply(e,arguments)}},isArray:function(t){return t instanceof Array},mixin:function(t){return o.call(arguments,1).forEach(function(e){for(var i in e)t[i]=e[i]}),t},querySelectorId:function(t,e){return e?e.querySelector("#"+t):void 0},insert:function(t,e,i){i!==void 0?e.splice(i,0,t):e.push(t)},toNode:function(t){var e=document.createElement("div");return e.innerHTML=t,e.removeChild(e.firstElementChild)},uniqueId:function(){var t=0;return function(e,i){return e=e||"id",i=i||"a",[e,++t*Math.round(1e5*Math.random()),i].join("-")}}()},h=s.mixin;i.util=s;var p=/\s+/,l={on:function(t,e,i){var o,n,r,s,h;if(!e)return this;for(t=t.split(p),o=this._callbacks||(this._callbacks={}),n=t.shift();n;)h=o[n],r=h?h.tail:{},r.next=s={},r.context=i,r.callback=e,o[n]={tail:s,next:h?h.next:r},n=t.shift();return this},off:function(t,e,i){var o,n,r,s,h,l;if(n=this._callbacks){if(!(t||e||i))return delete this._callbacks,this;for(t=t?t.split(p):Object.keys(n);o=t.shift();)if(r=n[o],delete n[o],r&&(e||i))for(s=r.tail;(r=r.next)!==s;)h=r.callback,l=r.context,(e&&h!==e||i&&l!==i)&&this.on(o,h,l);return this}},trigger:function(t){var e,i,n,r,s,h,l;if(!(n=this._callbacks))return this;for(h=n.all,t=t.split(p),l=o.call(arguments,1);e=t.shift();){if(i=n[e])for(r=i.tail;(i=i.next)!==r;)i.callback.apply(i.context||this,l);if(i=h)for(r=i.tail,s=[e].concat(l);(i=i.next)!==r;)i.callback.apply(i.context||this,s)}return this}};i.Events=l,t.prototype._configure=function(t){this._module=this._module||t._module,this._id=t.id||s.uniqueId("auto_"),this._fmid=t.fmid||s.uniqueId("fmid"),this.tag=t.tag||this.tag||"div",this.classes=this.classes||t.classes||[],this.helpers=this.helpers||t.helpers||[],this.template=this.getTemplate(),this._lookup={},this._children=[],this.model=t.model||new e(t.data||{}),this.helpers.forEach(this.attachHelper,this),this.purgeHtmlCache=s.bind(this.purgeHtmlCache,this),this.model.on("change",this.purgeHtmlCache)},t.prototype.on=l.on,t.prototype.off=l.off,t.prototype.trigger=function(t,e,i){var o;return s.isArray(e)||(i=e,e=[]),i=i||{target:this,stopPropagation:function(){this.propagate=!1}},l.trigger.apply(this,[t,i].concat(e)),o=i.propagate!==!1,o&&this.parent&&this.parent.trigger(t,e,i),this},t.prototype.attachHelper=function(t){t="function"==typeof t?t:u.helpers[t],t&&t(this,i)},t.prototype.getTemplate=function(){var t=this.template||i.templates.get(this._module);return t?t.render?s.bind(t.render,t):t:console.warn("FM - No template for %s",this._module)},t.prototype.add=function(e,i){var o,n=i&&i.at,r=i&&i.inject;if(e){e=[].concat(e);for(var h=0,p=e.length;p>h;h++)o=e[h],o instanceof t||(o=new t(o)),s.insert(o,this._children,n),this._addLookup(o),o.parent=this,r&&this.injectElement(o.el,i);return this.purgeHtmlCache(),this}},t.prototype._addLookup=function(t){this._lookup[t.id()]=t,this._lookup[t._module]=this._lookup[t._module]||[],this._lookup[t._module].push(t)},t.prototype._removeLookup=function(t){var e=this._lookup[t._module].indexOf(t);this._lookup[t._module].splice(e,1),delete this._lookup[t._id]},t.prototype.injectElement=function(t,e){var i=e&&e.at,o=this.el;t&&o&&(i!==void 0?o.insertBefore(t,o.children[i]):o.appendChild(t))},t.prototype.id=function(t){return t?this.module(t):this._id},t.prototype.child=function(t){var e=this._lookup[t];return e?e[0]||e:void 0},t.prototype.module=function(t){var e;return t?(e=this._lookup[t],e?e[0]||e:this.each(function(e){return e.child(t)})):this._module},t.prototype.children=function(t){return t?this._lookup[t]||[]:this._children},t.prototype.modules=function(t){var e=this._lookup[t]||[];return this.each(function(i){e=e.concat(i.children(t))}),e},t.prototype.each=function(t){for(var e,i=this.children(),o=i.length,n=0;o>n;n++)if(e=t(i[n]))return e},t.prototype.toHTML=function(){var t,e={};return this.html?this.html:(e.children=[],this.each(function(i){t=i.toHTML(),e[i.id()]=t,e.children.push(h({child:t},i.model.get()))}),t=this.template(h(e,this.model.get())),this.html=this._wrapHTML(t))},t.prototype._wrapHTML=function(t){return"<"+this.tag+' class="'+this._module+" "+this.classes.join(" ")+'" id="'+this._fmid+'">'+t+"</"+this.tag+">"},t.prototype.render=function(){var t=this.toHTML(),e=s.toNode(t);return this.setElement(e),this.trigger("render",{propagate:!1}),this},t.prototype.setup=function(t){var e=t&&t.shallow;return e||this.each(function(t){t.setup()}),this.getElement()?(this.isSetup&&this.teardown({shallow:!0}),this.trigger("setup",{propagate:!1}),this.onSetup(),this.isSetup=!0,this):this},t.prototype.teardown=function(t){var e=t&&t.shallow;return e||this.each(function(t){t.teardown()}),this.isSetup?(this.trigger("teardown",{propagate:!1}),this.onTeardown(),this.isSetup=!1,this):this},t.prototype.destroy=function(t){for(var e=this._children,i=e.length;i--;)e[i].destroy({el:!1});return this.destroyed?this:(this.remove(t),this.teardown(t),this.trigger("destroy",{propagate:!1}),this.onDestroy(),this.model.off("change",this.purgeHtmlCache),this.off(),this.destroyed=!0,this.el=this.model=this.parent=this._lookup=this._module=this._id=null,void 0)},t.prototype.onInitialize=function(){},t.prototype.onSetup=function(){},t.prototype.onTeardown=function(){},t.prototype.onDestroy=function(){},t.prototype.remove=function(t){t=t||{};var e,i=this.el;return t.el!==!1&&i&&i.parentNode&&i.parentNode.removeChild(i),this.parent?(e=this.parent._children.indexOf(this),this.parent._children.splice(e,1),this.parent._removeLookup(this),this):this},t.prototype.empty=function(){for(var t=this.children(),e=t.length;e--;)t[e].destroy();return this},t.prototype.closestElement=function(){for(var t=this.parent;t&&!t.el&&t.parent;)t=t.parent;return t&&t.el},t.prototype.getElement=function(){return r?this.el=this.el||document.getElementById(this._fmid)||this.parent&&s.querySelectorId(this._fmid,this.closestElement()):void 0},t.prototype.setElement=function(t){var e=this.el;return e&&e.parentNode&&e.parentNode.replaceChild(t,e),this.purgeElementCaches(),this.el=t,this},t.prototype.purgeElementCaches=function(){this.each(function(t){t.purgeElementCaches()}),this.el=null},t.prototype.purgeHtmlCache=function(){return this.html=null,this.parent&&this.parent.purgeHtmlCache(),this},t.prototype.data=function(t,e){return t||e?"string"!=typeof t||e?t&&e?(this.model.set(t,e),this):"object"==typeof t?(this.model.set(t),this):void 0:this.model.get(t):this.model.get()},t.prototype.inDOM=function(){return this.parent?this.parent.inDOM():!(!this.el||!this.el.parentNode)},t.prototype.inject=function(t){return t&&(t.innerHTML="",this.appendTo(t)),this},t.prototype.appendTo=function(t){return this.el&&t&&t.appendChild&&t.appendChild(this.el),this},t.prototype.toJSON=function(){var t={};return t.children=[],this.each(function(e){t.children.push(e.toJSON())}),t.id=this.id(),t.fmid=this._fmid,t.module=this._module,t.data=this.model.get(),t},i.View=t,e.prototype.get=function(t){return t?this._data[t]:this._data},e.prototype.set=function(t,e){var i;if("string"==typeof t&&e&&(i={},i[t]=e,t=i),"object"==typeof t){h(this._data,t),this.trigger("change");for(var o in t)this.trigger("change:"+o,t[o])}return this},e.prototype.clear=function(){return this._data={},this},e.prototype.destroy=function(){this._data=null},e.prototype.toJSON=function(){return h({},this._data)},h(e.prototype,l),i.Model=e,t.extend=function(t,e){var i,o=this;i=t&&n.call(t,"constructor")?t.constructor:function(){return o.apply(this,arguments)},h(i,o,e);var r=function(){this.constructor=i};return r.prototype=o.prototype,i.prototype=new r,t&&h(i.prototype,t),i.__super__=o.prototype,i};var u={modules:{},templates:{},helpers:{}};i.store=u,i.module=function(t){var e,o=t.module||"undefined";return delete t.module,e=t.__super__?t:i.View.extend(t),e.prototype._module=o,u.modules[o]=e},i.module.clear=function(t){t?delete u.modules[t]:u.modules={}},i.helper=function(t,e){u.helpers[t]=e},i.helper.clear=function(t){t?delete u.helpers[t]:u.helpers={}},i.templates=function(t){var e=typeof t;"object"===e?h(u.templates,t):"function"===e&&(i.templates.get=t)};var a=i.templates.get=function(t){return u.templates[t]};i.templates.clear=function(t){t?delete u.templates[t]:(u.templates={},i.templates.get=a)},"object"==typeof exports?module.exports=i:"function"==typeof define&&define.amd?define(i):window.FruitMachine=i})();