(function(j){function n(){console&&console.error.apply(console,arguments)}var f="object"===typeof exports?exports:j.FruitMachine={};f.VERSION="0.0.1";var m=Array.prototype.slice,g={slotClass:"js-module",moduleIdAttr:"data-module-id",moduleTypeAttr:"data-module-type",moduleDataAttr:"data-model-data",parentAttr:"data-parent",mustacheSlotArrayName:"children",templates:void 0,debug:0};f.set=function(a,b){"string"===typeof a?g[a]=b:d.extend(g,b)};f.Views={};var d=f.util={attributes:function(a){var b=[],
c;for(c in a)b.push(c+"='"+a[c]+"'");return b.join(" ")},ctor:function(){},escape:window.escape,unescape:window.unescape,extend:function(a){m.call(arguments,1).forEach(function(b){for(var c in b)a[c]=b[c]});return a},inherits:function(a,b){var c=this,e;e=a&&a.hasOwnProperty("constructor")?a.constructor:function(){c.apply(this,arguments)};d.extend(e,c);d.ctor.prototype=c.prototype;e.prototype=new d.ctor;a&&d.extend(e.prototype,a);b&&d.extend(e,b);e.prototype.constructor=e;e.__super__=c.prototype;return e},
insertChild:function(a,b,c){b&&("undefined"!==typeof c?b.insertBefore(a,b.children[c]):b.appendChild(a))},insert:function(a,b,c){"undefined"!==typeof c?b.splice(c,0,a):b.push(a)},isArray:function(a){return a instanceof Array},replaceEl:function(a,b){if(a.parentNode)return a.parentNode.replaceChild(b,a),b},toNode:function(a){if("string"!==typeof a)return a;var b=document.createElement("div");b.innerHTML=a;return b.firstElementChild},uniqueId:function(){var a=1;return function(b){return(b||"")+a++ +
"_"+Math.round(1E5*Math.random())}}(),extractEmbeddedData:function(a){var b=a.getAttribute(g.moduleDataAttr);if(!b)return{};b=JSON.parse(d.unescape(b));a.removeAttribute(g.moduleDataAttr);return b}},k=/\s+/,j={on:function(a,b,c){var e,i,d,g,f;if(!b)return this;a=a.split(k);e=this._callbacks||(this._callbacks={});for(i=a.shift();i;)d=(f=e[i])?f.tail:{},d.next=g={},d.context=c,d.callback=b,e[i]={tail:g,next:f?f.next:d},i=a.shift();return this},off:function(a,b,c){var e,i,d,g,f,h;if(i=this._callbacks){if(!a&&
!b&&!c)return delete this._callbacks,this;for(a=a?a.split(k):Object.keys(i);e=a.shift();)if(d=i[e],delete i[e],d&&(b||c))for(g=d.tail;(d=d.next)!==g;)if(f=d.callback,h=d.context,b&&f!==b||c&&h!==c)this.on(e,f,h);return this}},trigger:function(a){var b,c,e,d,g,f;if(!(e=this._callbacks))return this;g=e.all;a=a.split(k);for(f=m.call(arguments,1);b=a.shift();){if(c=e[b])for(d=c.tail;(c=c.next)!==d;)c.callback.apply(c.context||this,f);if(c=g){d=c.tail;for(b=[b].concat(f);(c=c.next)!==d;)c.callback.apply(c.context||
this,b)}}return this}};d.extend(f,j);var l=f.View=function(a){return new (f.Views[a.module]||h)(a)},h=function(a){var b,c,e;this._configure(a);this._globals.id[this._id]=this;if(b=this._childrenFromHtml(this._id)){c=0;for(e=b.length;c<e;c++)this._add(b[c])}if(a.children){c=0;for(e=a.children.length;c<e;c++)this._add(a.children[c])}f.trigger("beforeinitialize",this);this.initialize.call(this,a)};d.extend(h.prototype,j,{initialize:function(){},onSetup:function(){},onTeardown:function(){},onDestroy:function(){},
hasChild:function(a){return!!this.child(a)},add:function(a,b){var c;c=b&&b.at;var e=b&&b.append;if(!(a instanceof h)){c=[].concat(a);for(var e=0,i=c.length;e<i;e++)this.add(new l(c[e]));return this}if(this.hasChild(a.id()))return this;d.extend(this._globals.id,a._globals.id);a.parent=this;d.insert(a,this._children,c);this._childHash[a._id]=a;this._childHash[a.module]=this._childHash[a.module]||[];this._childHash[a.module].push(a);!1!==e&&a.el&&d.insertChild(a.el,this.el,c);return this},render:function(a){var b=
this._toHTML(a);if("undefined"===typeof b)return this;if(a&&a.asString)return b;a=d.toNode(b);this.el&&d.replaceEl(this.el,a);this.el=a;this.updateChildEls();this.trigger("render");return this},updateChildEls:function(){var a,b,c;this._purgeChildrenFromHtmlCache();c=this._childrenFromHtml();a=0;for(b=c.length;a<b;a++){var e=c[a],d=this.id(e._id);d&&(d.el=e.el)}return this},data:function(a,b){if(!a&&!b)return this._data;if("string"===typeof a&&!b)return this._data[a];if(a&&b)return this._data[a]=b,
this.trigger("datachange",a,b),this.trigger("datachange:"+a,b),this;if("object"===typeof a){d.extend(this._data,a);this.trigger("datachange");for(var c in a)this.trigger("datachange:"+a,a[c]);return this}},child:function(a){return(a=this._childHash[a])?a[0]||a:null},children:function(a){return a?this._childHash[a]:this._children},id:function(a){return a?this._globals.id[a]:this._id},inject:function(a){if(!a)return this;a.innerHTML="";a.appendChild(this.el);return this},setup:function(){for(var a=
0,b=this._children.length;a<b;a++)this._children[a].setup();this.isSetup&&this.teardown({shallow:!0});if(!this.el)return n("FruitMachine - No view.el found for view: '%s'",this.id());f.trigger("beforesetup",this);this.trigger("setup");this.onSetup();this.isSetup=!0;return this},teardown:function(a){if(!a||!a.shallow)for(var a=0,b=this._children.length;a<b;a++)this._children[a].teardown();f.trigger("beforeteardown",this);this.trigger("teardown");this.onTeardown();this.isSetup=!1;return this},empty:function(){for(;this._children.length;)this._children[0].destroy();
return this},destroy:function(a){for(;this._children.length;)this._children[0].destroy({skipEl:!0});this.teardown(a);f.trigger("beforedestroy",this);this._detach(a);this.trigger("destroy");this.onDestroy();this.destroyed=!0;this.el=this.module=this._id=this._globals=this._childHash=this._data=null},_configure:function(a){this.parent=a.parent;this.el=a.el;this.module=a.module;this._id=a._id||a.id||d.uniqueId("dynamic");this._children=[];this._globals=a._globals||{id:{}};this._childHash={};this._data=
d.extend({},a.data)},_add:function(a){a._globals=this._globals;this.add(new l(a),{append:!1})},_detach:function(a){(!a||!a.skipEl)&&(this.el&&this.el.parentNode)&&this.el.parentNode.removeChild(this.el);if(!this.parent)return this;a=this.parent._children.indexOf(this);this.parent._children.splice(a,1);a=this.parent._childHash[this.module].indexOf(this);this.parent._childHash[this.module].splice(a,1);delete this.parent._childHash[this._id];delete this.parent._globals.id[this._id];return this},_toHTML:function(a){var b=
g.templates(this.module),c={};if(!1!==this.render){if(!b)return"";c[g.mustacheSlotArrayName]=[];if(this._children)for(var e=0,f=this._children.length;e<f;e++){var h=this._children[e],j=h._toHTML(a);c[g.mustacheSlotArrayName].push(d.extend({child:j},h.data()));c[h._id]=j}c.fm_classes=g.slotClass;c.fm_attrs=this._htmlAttrs(a);return b(d.extend(c,this.data()))}},_htmlAttrs:function(a){var b={},c=a&&a.embedData,a=a&&a.forClient;b[g.moduleIdAttr]=this._id;b[g.moduleTypeAttr]=this.module;c&&(b[g.moduleDataAttr]=
d.escape(JSON.stringify(this.data())));a&&this.parent&&(b[g.moduleParentAttr]=this.parent._id);return d.attributes(b)},_childrenFromHtml:function(a){var b,c,e=[],f=this._globals.childrenFromHtml;if(!this.el)return e;if(f)return a?f[a]:f;f=this._globals.childrenFromHtml=[];b=this.el.getElementsByClassName(g.slotClass);for(var h=0,j=b.length;h<j;h++)c=b[h],c={el:c,_id:c.getAttribute(g.moduleIdAttr)||d.uniqueId("unknown"),module:c.getAttribute(g.moduleTypeAttr)||"undefined",parentId:c.getAttribute(g.parentAttr),
data:d.extractEmbeddedData(c)},(!a||a===c.parentId)&&e.push(c),f.push(c),f[c.parentId]=f[c.parentId]||[],f[c.parentId].push(c);return e},_purgeChildrenFromHtmlCache:function(){delete this._globals.childrenFromHtml}});l.extend=function(a,b,c){f.Views[a]=h.extend(b,c)};h.extend=d.inherits})(this);
