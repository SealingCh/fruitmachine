(function(n){var h="object"===typeof exports?exports:n.FruitMachine={};h.VERSION="0.0.1";var m=Array.prototype.slice,g={slotClass:"js-module",moduleIdAttr:"data-module-id",moduleTypeAttr:"data-module-type",moduleDataAttr:"data-model-data",moduleParentAttr:"data-parent",mustacheSlotArrayName:"children",templates:void 0,debug:0};h.set=function(a,b){"string"===typeof a?g[a]=b:e.extend(g,b)};h.Views={};var e=h.util={attributes:function(a){var b=[],c;for(c in a)b.push(c+"='"+a[c]+"'");return b.join(" ")},
ctor:function(){},escape:window.escape,unescape:window.unescape,extend:function(a){m.call(arguments,1).forEach(function(b){for(var c in b)a[c]=b[c]});return a},inherits:function(a,b){var c=this,d;d=a&&a.hasOwnProperty("constructor")?a.constructor:function(){c.apply(this,arguments)};e.extend(d,c);e.ctor.prototype=c.prototype;d.prototype=new e.ctor;a&&e.extend(d.prototype,a);b&&e.extend(d,b);d.prototype.constructor=d;d.__super__=c.prototype;return d},insertChild:function(a,b,c){b&&("undefined"!==typeof c?
b.insertBefore(a,b.children[c]):b.appendChild(a))},insert:function(a,b,c){"undefined"!==typeof c?b.splice(c,0,a):b.push(a)},isArray:function(a){return a instanceof Array},replaceContent:function(a,b){b.innerHTML="";for(var c=a.childNodes,d=0,f=c.length;d<f;d++)b.appendChild(c[0]);return b},toNode:function(a){if("string"!==typeof a)return a;var b=document.createElement("div");b.innerHTML=a;return b.firstElementChild},uniqueId:function(){var a=1;return function(b){return(b||"")+a++ +"_"+Math.round(1E5*
Math.random())}}()},k=/\s+/,l=h.View=function(a){return new (h.Views[a.module]||i)(a)},i=function(a){var b,c,d;this._configure(a);this._globals.id[this._id]=this;a.skipFindModuleNodes||(this._globals.dom=this._getDomChildren());if(b=this._globals.dom.byParent&&this._globals.dom.byParent[this._id]){c=0;for(d=b.length;c<d;c++)this._add(b[c])}if(a.children){c=0;for(d=a.children.length;c<d;c++)this._add(a.children[c])}this.initialize.call(this,a)};e.extend(i.prototype,{on:function(a,b,c){var d,f,e,g,
j;if(!b)return this;a=a.split(k);d=this._callbacks||(this._callbacks={});for(f=a.shift();f;)e=(j=d[f])?j.tail:{},e.next=g={},e.context=c,e.callback=b,d[f]={tail:g,next:j?j.next:e},f=a.shift();return this},off:function(a,b,c){var d,f,e,g,j,h;if(f=this._callbacks){if(!a&&!b&&!c)return delete this._callbacks,this;for(a=a?a.split(k):Object.keys(f);d=a.shift();)if(e=f[d],delete f[d],e&&(b||c))for(g=e.tail;(e=e.next)!==g;)if(j=e.callback,h=e.context,b&&j!==b||c&&h!==c)this.on(d,j,h);return this}},trigger:function(a){var b,
c,d,e,g,h;if(!(d=this._callbacks))return this;g=d.all;a=a.split(k);for(h=m.call(arguments,1);b=a.shift();){if(c=d[b])for(e=c.tail;(c=c.next)!==e;)c.callback.apply(c.context||this,h);if(c=g){e=c.tail;for(b=[b].concat(h);(c=c.next)!==e;)c.callback.apply(c.context||this,b)}}return this}},{_configure:function(a){this.parent=a.parent;this.el=a.el;this.module=a.module;this._id=a._id||a.id||e.uniqueId("dynamic");this._children=[];this._globals=a._globals||{id:{},domChildren:{}};this._childHash={};this._data=
a.data||{}},initialize:function(){},onSetup:function(){},onTeardown:function(){},onDestroy:function(){},_add:function(a){this._childHash[a._id||a.id]||(a._globals=this._globals,a.skipFindModuleNodes=!0,this.add(new l(a),{append:!1}))},add:function(a,b){var c=b&&b.at,d=b&&b.append;if(e.isArray(a)){c=0;for(d=a.length;c<d;c++)this.add(new l(a[c]));return this}e.extend(this._globals.id,a._globals.id);a.parent=this;e.insert(a,this._children,c);this._childHash[a._id]=a;this._childHash[a.module]=this._childHash[a.module]||
[];this._childHash[a.module].push(a);!1!==d&&a.el&&e.insertChild(a.el,this.el,c);return this},render:function(a){var b=this._toHTML(a);if(a&&a.asString)return b;a=e.toNode(b);this.el?e.replaceContent(a,this.el):this.el=a;this.updateChildEls();this.trigger("render");return this},updateChildEls:function(){for(var a=this._getDomChildren().all,b=0,c=a.length;b<c;b++){var d=a[b];this.id(d._id).el=d.el}return this},data:function(a,b){if(!a&&!b)return this._data;if("string"===typeof a&&!b)return this._data[a];
if(a&&b)return this._data[a]=b,this.trigger("datachange"),this;if("object"===typeof a)return e.extend(this._data,a),this.trigger("datachange"),this},child:function(a){a=this._childHash[a];return a[0]||a},children:function(a){return this._childHash[a]},id:function(a){return a?this._globals.id[a]:this._id},inject:function(a){if(!a)return this;a.innerHTML="";a.appendChild(this.el);return this},setup:function(){for(var a=0,b=this._children.length;a<b;a++)this._children[a].setup();this.isSetup&&this.teardown();
this.trigger("setup");this.onSetup();this.isSetup=!0;return this},teardown:function(){for(var a=0,b=this._children.length;a<b;a++)this._children[a].teardown();this.trigger("teardown");this.onTeardown();this.isSetup=!1;return this},_detach:function(a){(!a||!a.skipEl)&&(this.el&&this.el.parentNode)&&this.el.parentNode.removeChild(this.el);if(!this.parent)return this;a=this.parent._children.indexOf(this);this.parent._children.splice(a,1);a=this.parent._childHash[this.module].indexOf(this);this.parent._childHash[this.module].splice(a,
1);delete this.parent._childHash[this._id];delete this.parent._globals.id[this._id];return this},empty:function(){for(;this._children.length;)this._children[0].destroy();return this},destroy:function(a){for(;this._children.length;)this._children[0].destroy({skipEl:!0});this.teardown(a);this._detach(a);this.trigger("destroy");this.onDestroy();this.destroyed=!0;this.el=this.module=this._id=this._globals=this._childHash=this._data=null},_toHTML:function(a){var b=g.templates(this.module),c={};if(!1!==
this.render&&b){c[g.mustacheSlotArrayName]=[];if(this._children)for(var d=0,f=this._children.length;d<f;d++){var h=this._children[d],i=h._toHTML(a);if(!i)return;c[g.mustacheSlotArrayName].push(e.extend({child:i},h._data));c[h._id]=i}c.fm_classes=g.slotClass;c.fm_attrs=this._makeAttrs(a);return b(e.extend(c,this._data))}},_makeAttrs:function(a){var b={},c=a&&a.embedData,a=a&&a.forClient;b[g.moduleIdAttr]=this._id;b[g.moduleTypeAttr]=this.module;c&&(b[g.moduleDataAttr]=e.escape(JSON.stringify(this._data)));
a&&this.parent&&(b[g.moduleParentAttr]=this.parent._id);return e.attributes(b)},_extractEmbeddedData:function(a){var b=a.getAttribute(g.moduleDataAttr);if(!b)return{};b=JSON.parse(e.unescape(b));a.removeAttribute(g.moduleDataAttr);return b},_getDomChildren:function(){var a,b={all:[],byParent:{}};if(!this.el)return b;a=this.el.getElementsByClassName(g.slotClass);for(var c=0,d=a.length;c<d;c++){var f=a[c],f={el:f,_id:f.getAttribute(g.moduleIdAttr)||e.uniqueId("unknown"),module:f.getAttribute(g.moduleTypeAttr)||
"undefined",parentId:f.getAttribute(g.moduleParentAttr),data:this._extractEmbeddedData(f)};b.all.push(f);f.parentId&&(b.byParent[f.parentId]=b.byParent[f.parentId]||[],b.byParent[f.parentId].push(f))}return b}});l.extend=function(a,b,c){h.Views[a]=i.extend(b,c)};i.extend=e.inherits})(this);
