(function(n){var f="object"===typeof exports?exports:n.FruitMachine={};f.VERSION="0.0.1";var g=f.SETTINGS={breakpointDebounce:50,slotClass:"js-module",moduleIdAttr:"data-module-id",moduleTypeAttr:"data-module-type",moduleDataAttr:"data-model-data",moduleParentAttr:"data-parent",mustacheSlotVarPrefix:"module",mustacheSlotArrayName:"modules"},k={};f.templates=function(a){e.extend(k,a)};var l=Array.prototype.slice;f.Views={};var e=f.util={attributes:function(a){var b=[],c;for(c in a)b.push(c+"='"+a[c]+
"'");return b.join(" ")},ctor:function(){},escape:window.escape,unescape:window.unescape,extend:function(a){l.call(arguments,1).forEach(function(b){for(var c in b)a[c]=b[c]});return a},inherits:function(a,b){var c=this,d;d=a&&a.hasOwnProperty("constructor")?a.constructor:function(){c.apply(this,arguments)};e.extend(d,c);e.ctor.prototype=c.prototype;d.prototype=new e.ctor;a&&e.extend(d.prototype,a);b&&e.extend(d,b);d.prototype.constructor=d;d.__super__=c.prototype;return d},insertChild:function(a,
b,c){b&&("undefined"!==typeof c?b.insertBefore(a,b.children[c]):b.appendChild(a))},insert:function(a,b,c){"undefined"!==typeof c?b.splice(c,0,a):b.push(a)},replaceContent:function(a,b){b.innerHTML="";for(var c=a.childNodes,d=0,h=c.length;d<h;d++)b.appendChild(c[0]);return b},toNode:function(a){if("string"!==typeof a)return a;var b=document.createElement("div");b.innerHTML=a;return b.firstElementChild},uniqueId:function(){var a=1;return function(b){return(b||"")+a++ +"_"+Math.round(1E5*Math.random())}}()},
j=/\s+/,m=f.View=function(a){return new (f.Views[a.module]||i)(a)},i=function(a){var b,c,d;this._configure(a);this._globals.id[this._id]=this;a.skipFindModuleNodes||(this._globals.dom=this._getDomChildren());if(b=this._globals.dom.byParent&&this._globals.dom.byParent[this._id]){c=0;for(d=b.length;c<d;c++)this._add(b[c])}if(a.children){c=0;for(d=a.children.length;c<d;c++)this._add(a.children[c])}this.initialize.call(this,a)};e.extend(i.prototype,{on:function(a,b,c){var d,h,e,g,f;if(!b)return this;
a=a.split(j);for(d=this._callbacks||(this._callbacks={});h=a.shift();)e=(f=d[h])?f.tail:{},e.next=g={},e.context=c,e.callback=b,d[h]={tail:g,next:f?f.next:e};return this},off:function(a,b,c){var d,h,e,g,f,i;if(h=this._callbacks){if(!a&&!b&&!c)return delete this._callbacks,this;for(a=a?a.split(j):Object.keys(h);d=a.shift();)if(e=h[d],delete h[d],e&&(b||c))for(g=e.tail;(e=e.next)!==g;)if(f=e.callback,i=e.context,b&&f!==b||c&&i!==c)this.on(d,f,i);return this}},trigger:function(a){var b,c,d,e,g,f;if(!(d=
this._callbacks))return this;g=d.all;a=a.split(j);for(f=l.call(arguments,1);b=a.shift();){if(c=d[b])for(e=c.tail;(c=c.next)!==e;)c.callback.apply(c.context||this,f);if(c=g){e=c.tail;for(b=[b].concat(f);(c=c.next)!==e;)c.callback.apply(c.context||this,b)}}return this}},{_configure:function(a){this.parent=a.parent;this.el=a.el;this.module=a.module;this._id=a._id||a.id||e.uniqueId("dynamic");this._children=[];this._globals=a._globals||{id:{},domChildren:{}};this._childHash={};this._data=a.data||{}},
initialize:function(){},_add:function(a){this._childHash[a._id||a.id]||(a._globals=this._globals,a.skipFindModuleNodes=!0,this.add(new m(a),{append:!1}))},add:function(a,b){var c=b&&b.at,d=b&&b.append;e.extend(this._globals.id,a._globals.id);a.parent=this;e.insert(a,this._children,c);this._childHash[a._id]=a;this._childHash[a.module]=this._childHash[a.module]||[];this._childHash[a.module].push(a);!1!==d&&a.el&&e.insertChild(a.el,this.el,c);return this},remove:function(){},render:function(a){var b=
this._toHTML(a);if(a&&a.asString)return b;a=e.toNode(b);this.el&&e.replaceContent(a,this.el);this.el=a;this.updateChildEls();this.trigger("render");return this},updateChildEls:function(){for(var a=this._getDomChildren().all,b=0,c=a.length;b<c;b++){var d=a[b];this.id(d._id).el=d.el}return this},get:function(a){return a?this[a]||this._data[a]:this._data},set:function(a,b){"string"===typeof a?this._data[a]=b:e.extend(this._data,a);return this},child:function(a){a=this._childHash[a];return a[0]||a},children:function(a){return this._childHash[a]},
id:function(a){return a?this._globals.id[a]:this._id},inject:function(a){if(!a)return this;a.innerHTML="";a.appendChild(this.el);return this},setup:function(){for(var a=0,b=this._children.length;a<b;a++)this._children[a].setup();if(this.isSetup)return this;this.trigger("setup");this.isSetup=!0},_detach:function(a){(!a||!a.skipEl)&&(this.el&&this.el.parentNode)&&this.el.parentNode.removeChild(this.el);if(!this.parent)return this;a=this.parent._children.indexOf(this);this.parent._children.splice(a,
1);a=this.parent._childHash[this.module].indexOf(this);this.parent._childHash[this.module].splice(a,1);delete this.parent._childHash[this._id];delete this.parent._globals.id[this._id];return this},destroy:function(a){for(var b=0,c=this._children.length;b<c;b++)this._children[b].destroy({skipEl:!0});this._detach(a);this.trigger("destroy");this.el=this.module=this._id=this._globals=this._childHash=this._data=null},_toHTML:function(a){var b=this.template||k[this.module],c={};if(!1!==this.render&&b&&
b.render){c[g.mustacheSlotArrayName]=[];if(this._children)for(var d=0,h=this._children.length;d<h;d++){var f=this._children[d],i=f._toHTML(a);if(!i)return;c[g.mustacheSlotArrayName].push(e.extend({module:i},f._data));c[g.mustacheSlotVarPrefix+f._id]=i}c.fm_classes="js-module";c.fm_attrs=this._makeAttrs(a);return b.render(e.extend(c,this._data))}},_makeAttrs:function(a){var b={},c=a&&a.embedData,a=a&&a.forClient;b[g.moduleIdAttr]=this._id;b[g.moduleTypeAttr]=this.module;c&&(b[g.moduleDataAttr]=e.escape(JSON.stringify(this._data)));
a&&this.parent&&(b[g.moduleParentAttr]=this.parent._id);return e.attributes(b)},_extractEmbeddedData:function(a){var b=a.getAttribute(g.moduleDataAttr);if(!b)return{};b=JSON.parse(e.unescape(b));a.removeAttribute(g.moduleDataAttr);return b},_getDomChildren:function(){var a,b={all:[],byParent:{}};if(!this.el)return b;a=this.el.getElementsByClassName(g.slotClass);for(var c=0,d=a.length;c<d;c++){var f=a[c],f={el:f,_id:f.getAttribute(g.moduleIdAttr)||e.uniqueId("unknown"),module:f.getAttribute(g.moduleTypeAttr)||
"undefined",parentId:f.getAttribute(g.moduleParentAttr),data:this._extractEmbeddedData(f)};b.all.push(f);f.parentId&&(b.byParent[f.parentId]=b.byParent[f.parentId]||[],b.byParent[f.parentId].push(f))}return b}});m.extend=function(a,b){f.Views[a]=i.extend(b)};i.extend=e.inherits;return f})(this);
