(function(){var k,l,m,f=function(a){if(a.module){var b=k[a.module]||f;a._module=a.module;delete a.module;return new b(a)}this._configure(a);this.add(a.children);this.onInitialize(a)};f.VERSION="0.0.1";k={};l={};m={};var j=f.util={bind:function(a,b){return function(){return a.apply(b,arguments)}},bindAll:function(a,b){for(var c in a)"function"===typeof a[c]&&(a[c]=j.bind(a[c],b))},mixin:function(a){o.call(arguments,1).forEach(function(b){for(var c in b)a[c]=b[c]});return a},insertChild:function(a,
b,c){b&&("undefined"!==typeof c?b.insertBefore(a,b.children[c]):b.appendChild(a))},insert:function(a,b,c){"undefined"!==typeof c?b.splice(c,0,a):b.push(a)},uniqueId:function(){var a=0;return function(b){return(b||"")+ ++a*Math.round(1E7*Math.random())}}()},o=Array.prototype.slice,q=Object.prototype.hasOwnProperty,g=j.mixin,n=/\s+/,r=f.Events={on:function(a,b,c){var d,e,h,f,i;if(!b)return this;a=a.split(n);d=this._callbacks||(this._callbacks={});for(e=a.shift();e;)h=(i=d[e])?i.tail:{},h.next=f={},
h.context=c,h.callback=b,d[e]={tail:f,next:i?i.next:h},e=a.shift();return this},off:function(a,b,c){var d,e,h,f,i,g;if(e=this._callbacks){if(!a&&!b&&!c)return delete this._callbacks,this;for(a=a?a.split(n):Object.keys(e);d=a.shift();)if(h=e[d],delete e[d],h&&(b||c))for(f=h.tail;(h=h.next)!==f;)if(i=h.callback,g=h.context,b&&i!==b||c&&g!==c)this.on(d,i,g);return this}},trigger:function(a){var b,c,d,e,f,g;if(!(d=this._callbacks))return this;f=d.all;a=a.split(n);for(g=o.call(arguments,1);b=a.shift();){if(c=
d[b])for(e=c.tail;(c=c.next)!==e;)c.callback.apply(c.context||this,g);if(c=f){e=c.tail;for(b=[b].concat(g);(c=c.next)!==e;)c.callback.apply(c.context||this,b)}}return this}};f.helper=function(a,b){m[a]=b(f)};var p=function(a){return l[a]};f.templates=function(a){var b=typeof a;"object"===b?g(l,a):"function"===b&&(p=a)};var s=function(a){var b=m[a];if(b)return"function"===typeof b?this[a]=new b(this):g(this,b)},t=function(a){if(a.onSetup)a.onSetup()},u=function(a){if(a.onTeardown)a.onTeardown()};g(f.prototype,
r,{_configure:function(a){this._id=a.id||j.uniqueId("auto_");this._fmid=a.fmid||j.uniqueId("fmid");this.module=a._module;this._lookup={};this._children=[];this._data=a.data||{};this.template=this.template||p(this.module);this.helpers=(this.helpers||[]).map(s,this)},onInitialize:function(){},onSetup:function(){},onTeardown:function(){},onDestroy:function(){},add:function(a,b){var c=b&&b.at,d=b&&b.append,e;if(a){for(var a=[].concat(a),h=0,g=a.length;h<g;h++)e=a[h],e instanceof f||(e=new f(e)),j.insert(e,
this._children,c),this.addLookup(e),e.parent=this,!1!==d&&this.insertChildEl(e.el(),b);return this}},insertChildEl:function(a,b){var c=b&&b.at,d=this.el();a&&d&&("undefined"!==typeof c?d.insertBefore(a,d.children[c]):d.appendChild(a))},addLookup:function(a){this._lookup[a.id()]=a;this._lookup[a.module]=this._lookup[a.module]||[];this._lookup[a.module].push(a)},id:function(a){return a?this._lookup[a]:this._id},child:function(a){return this._lookup[a][0]},children:function(a){return a?this._lookup[a]:
this._children},fmid:function(){return this._fmid},toHTML:function(){var a={},b=this.children(),c,d;a.children=[];if(!this.template)return console.log("FM - No template for %s",this.module);for(var e=0,f=b.length;e<f;e++)c=b[e],d=c.toHTML(),a[c.id()]=d,a.children.push({child:d});a.fm_attrs='id="'+this.fmid()+'"';return this._html=this.template.render(g(a,this.data()))},render:function(){return this.update()},setup:function(a){var b=a&&a.shallow,a=this.children();if(!b)for(var b=0,c=a.length;b<c;b++)a[b].setup();
this.isSetup&&this.teardown({shallow:!0});this.helpers.forEach(t,this);this.onSetup();this.trigger("setup");this.isSetup=!0;return this},teardown:function(a){var b=a&&a.shallow,a=this.children();if(!b)for(var b=0,c=a.length;b<c;b++)a[b].teardown();this.helpers.forEach(u,this);this.trigger("teardown");this.onTeardown();this.isSetup=!1;return this},destroy:function(a){for(;this._children.length;)this._children[0].destroy({remove:!1});this.teardown(a);this._detach(a);this.trigger("destroy");this.onDestroy();
this.destroyed=!0;this._el=this.module=this._id=this._lookup=null},remove:function(){var a=this.el();a&&a.parentNode&&a.parentNode.removeChild(a)},_detach:function(a){!1!==(a&&a.skipEl)&&this.remove();if(!this.parent)return this;a=this.parent._children.indexOf(this);this.parent._children.splice(a,1);a=this.parent._lookup[this.module].indexOf(this);this.parent._lookup[this.module].splice(a,1);delete this.parent._lookup[this._id];return this},parentEl:function(){for(var a=this.parent;a&&!a._el&&a.parent;)a=
a.parent;return a._el},el:function(){return this._el=this._el||document.getElementById(this.fmid())},data:function(a,b){if(!a&&!b)return this._data;if("string"===typeof a&&!b)return this._data[a];if(a&&b)return this._data[a]=b,this.trigger("datachange",a,b),this.trigger("datachange:"+a,b),this;if("object"===typeof a){g(this._data,a);this.trigger("datachange");for(var c in a)this.trigger("datachange:"+c,a[c]);return this}},update:function(){var a=this.el(),b=this.toNode();if(!a)return this._el=b,this;
a.parentNode.replaceChild(b,a);this._el=b;return this},toNode:function(){var a=document.createElement("div");a.innerHTML=this.toHTML();return a.firstElementChild},inject:function(a){var b=this.el();if(b)return a.innerHTML="",a.appendChild(b),this},toJSON:function(){var a={},b=this.children();a.children=[];for(var c=0,d=b.length;c<d;c++)a.children.push(b[c].toJSON());a.id=this.id();a.fmid=this.fmid();a.module=this.module;a.data=this.data();return a}});f.inherit=function(a,b){var c=this,d;d=a&&q.call(a,
"constructor")?a.constructor:function(){return c.apply(this,arguments)};g(d,c,b);var e=function(){this.constructor=d};e.prototype=c.prototype;d.prototype=new e;a&&g(d.prototype,a);d.__super__=c.prototype;return d};f.module=function(a,b){if("string"===typeof a)return k[a]=f.inherit(b);if("object"===typeof a)return f.inherit(a)};"object"===typeof exports?module.exports=f:"function"===typeof define&&define.amd?define(f):window.FruitMachine=f})();
