(function(){var n=Array.prototype.slice,s=Object.prototype.hasOwnProperty,t="undefined"!==typeof document,k={},o={},l={},f=function(a){return new j(a)};f.VERSION="0.0.1";var i=f.util={bind:function(a,b){return function(){return a.apply(b,arguments)}},bindAll:function(a,b){for(var c in a)"function"===typeof a[c]&&(a[c]=i.bind(a[c],b))},mixin:function(a){n.call(arguments,1).forEach(function(b){for(var c in b)a[c]=b[c]});return a},querySelectorId:function(a,b){if(b)return b.querySelector("#"+a)},insert:function(a,
b,c){"undefined"!==typeof c?b.splice(c,0,a):b.push(a)},uniqueId:function(){var a=0;return function(b,c){return[b||"id",++a*Math.round(1E5*Math.random()),c||"a"].join("-")}}()},g=i.mixin,m=/\s+/,p=f.Events={on:function(a,b,c){var d,e,h,f,g;if(!b)return this;a=a.split(m);d=this._callbacks||(this._callbacks={});for(e=a.shift();e;)h=(g=d[e])?g.tail:{},h.next=f={},h.context=c,h.callback=b,d[e]={tail:f,next:g?g.next:h},e=a.shift();return this},off:function(a,b,c){var d,e,h,f,g,i;if(e=this._callbacks){if(!a&&
!b&&!c)return delete this._callbacks,this;for(a=a?a.split(m):Object.keys(e);d=a.shift();)if(h=e[d],delete e[d],h&&(b||c))for(f=h.tail;(h=h.next)!==f;)if(g=h.callback,i=h.context,b&&g!==b||c&&i!==c)this.on(d,g,i);return this}},trigger:function(a){var b,c,d,e,f,g;if(!(d=this._callbacks))return this;f=d.all;a=a.split(m);for(g=n.call(arguments,1);b=a.shift();){if(c=d[b])for(e=c.tail;(c=c.next)!==e;)c.callback.apply(c.context||this,g);if(c=f){e=c.tail;for(b=[b].concat(g);(c=c.next)!==e;)c.callback.apply(c.context||
this,b)}}return this}};f.helper=function(a,b){l[a]=b(f)};f.helper.remove=function(a){delete l[a]};var u=function(a){var b=l[a];if(b)return"function"===typeof b?this[a]=new b(this):g(this,b)},v=function(a){if(a.onSetup)a.onSetup()},w=function(a){if(a.onTeardown)a.onTeardown()};f.templates=function(a){var b=typeof a;"object"===b?g(o,a):"function"===b&&(q=a)};var q=function(a){return o[a]},j=f.View=function(a){a=g({},a);if(a.module){var b=k[a.module]||f;a._module=a.module;delete a.module;return new b(a)}this._configure(a);
this.add(a.children);this.onInitialize(a)};g(j.prototype,p,{_configure:function(a){this._id=a.id||i.uniqueId("auto_");this._fmid=a.fmid||i.uniqueId("fmid");this.module=this.module||a._module;this._lookup={};this._children=[];this.model=a.model||new r(a.data||{});this.model.on("change",i.bind(this.purgeHtmlCache,this));this.template=this.template||q(this.module);this.helpers=(this.helpers||[]).map(u,this)},onInitialize:function(){},onSetup:function(){},onTeardown:function(){},onDestroy:function(){},
add:function(a,b){var c=b&&b.at,d=b&&b.inject,e;if(a){for(var a=[].concat(a),g=0,j=a.length;g<j;g++)e=a[g],e instanceof f||(e=new f(e)),i.insert(e,this._children,c),this.addLookup(e),e.parent=this,d&&this.injectElement(e.el(),b);return this}},addLookup:function(a){this._lookup[a.id()]=a;this._lookup[a.module]=this._lookup[a.module]||[];this._lookup[a.module].push(a)},injectElement:function(a,b){var c=b&&b.at,d=this.el();a&&d&&("undefined"!==typeof c?d.insertBefore(a,d.children[c]):d.appendChild(a))},
id:function(a){return a?this._lookup[a]:this._id},child:function(a){return(a=this._lookup[a])&&a[0]||a},children:function(a){return a?this._lookup[a]:this._children},fmid:function(){return this._fmid},toHTML:function(){var a={},b=this.children(),c,d;a.children=[];if(this.html)return this.html;if(!this.template)return console.log("FM - No template for %s",this.module);for(var e=0,f=b.length;e<f;e++)c=b[e],d=c.toHTML(),a[c.id()]=d,a.children.push({child:d});d=this.template.render(g(a,this.model.get()));
return this.html=this.wrapHTML(d)},wrapHTML:function(a){return'<div class="'+this.module+'" id="'+this.fmid()+'">'+a+"</div>"},purgeHtmlCache:function(){this.html=null;this.parent&&this.parent.purgeHtmlCachep();return this},render:function(){console.time("render");this.setElement(this.toNode());console.timeEnd("render");return this},setup:function(a){var b=a&&a.shallow,a=this.children();if(!b)for(var b=0,c=a.length;b<c;b++)a[b].setup();this.isSetup&&this.teardown({shallow:!0});this.helpers.forEach(v,
this);this.onSetup();this.trigger("setup");this.isSetup=!0;return this},teardown:function(a){var b=a&&a.shallow,a=this.children();if(!b)for(var b=0,c=a.length;b<c;b++)a[b].teardown();this.helpers.forEach(w,this);this.clearElement();this.trigger("teardown");this.onTeardown();this.isSetup=!1;return this},destroy:function(a){for(;this._children.length;)this._children[0].destroy({remove:!1});this.teardown(a);this._detach(a);this.trigger("destroy");this.onDestroy();this.destroyed=!0;this._el=this.model=
this.module=this._id=this._lookup=null},remove:function(){var a=this.el();a&&a.parentNode&&a.parentNode.removeChild(a);return this},_detach:function(a){!1!==(a&&a.skipEl)&&this.remove();if(!this.parent)return this;a=this.parent._children.indexOf(this);this.parent._children.splice(a,1);a=this.parent._lookup[this.module].indexOf(this);this.parent._lookup[this.module].splice(a,1);delete this.parent._lookup[this._id];return this},closestElement:function(){for(var a=this.parent;a&&!a._el&&a.parent;)a=
a.parent;return a&&a._el},el:function(){if(t)return this._el=this._el||document.getElementById(this.fmid())||this.parent&&i.querySelectorId(this.fmid(),this.closestElement())},setElement:function(a){var b=this.el();b&&b.parentNode&&b.parentNode.replaceChild(a,b);this.purgeElementCaches();this._el=a;return this},clearElement:function(){this._el=null},purgeElementCaches:function(){var a=this.children(),b=a.length,c;for(c=0;c<b;c++)a[c].purgeElementCaches();this.clearElement()},data:function(a,b){if(!a&&
!b)return this.model.get();if("string"===typeof a&&!b)return this.model.get(a);if(a&&b)return this.model.set(a,b),this;if("object"===typeof a)return this.model.set(a),this},inDOM:function(){return this.parent?this.parent.inDOM():!(!this._el||!this._el.parentNode)},toNode:function(){var a=document.createElement("div");a.innerHTML=this.toHTML();return a.removeChild(a.firstElementChild)},inject:function(a){var b=this.el();if(b)return a.innerHTML="",a.appendChild(b),this},toJSON:function(){var a={},b=
this.children();a.children=[];for(var c=0,d=b.length;c<d;c++)a.children.push(b[c].toJSON());a.id=this.id();a.fmid=this.fmid();a.module=this.module;a.data=this.model.get();return a}});var r=f.Model=function(a){this.fmid=i.uniqueId("model");this._data=g({},a)};g(r.prototype,p,{get:function(a){return a?this._data[a]:this._data},set:function(a,b){var c;"string"===typeof a&&b&&(c={},c[a]=b,a=c);if("object"===typeof a){g(this._data,a);this.trigger("change");for(var d in a)this.trigger("change:"+d,a[d])}return this},
clear:function(){this._data={};return this},destroy:function(){this._data=null},toJSON:function(){return g({},this._data)}});j.inherit=function(a,b){var c=this,d;d=a&&s.call(a,"constructor")?a.constructor:function(){return c.apply(this,arguments)};g(d,c,b);var e=function(){this.constructor=d};e.prototype=c.prototype;d.prototype=new e;a&&g(d.prototype,a);d.__super__=c.prototype;return d};f.module=function(a,b){if("string"===typeof a)return b.module=a,k[a]=j.inherit(b);if("object"===typeof a)return j.inherit(a)};
f.module.clear=function(a){delete k[a]};"object"===typeof exports?module.exports=f:"function"===typeof define&&define.amd?define(f):window.FruitMachine=f})();
